generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id                    String         @id @default(uuid())
  name                  String
  whatsappPhoneNumberId String         @unique
  whatsappAccessToken   String         @db.Text
  webhookVerifyToken    String
  greetingMessage       String?        @db.Text
  outOfOfficeMessage    String?        @db.Text
  autoAssignEnabled     Boolean        @default(true)
  businessHoursEnabled  Boolean        @default(false)
  businessHoursStart    String         @default("08:00") // Format HH:mm
  businessHoursEnd      String         @default("18:00") // Format HH:mm
  businessDays          String         @default("1,2,3,4,5") // 0=Sun, 1=Mon...
  isActive              Boolean        @default(true)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  users                 User[]
  conversations         Conversation[]
  messages              Message[]
  auditLogs             AuditLog[]
  quickReplies          QuickReply[]
  departments           Department[]
  conversationNotes     ConversationNote[]
  passwordResetRequests PasswordResetRequest[]

  @@map("companies")
}

model Department {
  id                     String   @id @default(uuid())
  companyId              String
  name                   String
  slug                   String
  description            String?
  color                  String   @default("#6366f1")
  isRoot                 Boolean  @default(false)
  isActive               Boolean  @default(true)
  responseTimeoutMinutes Int      @default(3)
  maxAgents              Int      @default(2)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  company       Company        @relation(fields: [companyId], references: [id])
  users         User[]
  conversations Conversation[]

  @@unique([companyId, slug])
  @@map("departments")
}

model User {
  id                String     @id @default(uuid())
  companyId         String
  departmentId      String?
  email             String     @unique
  passwordHash      String
  plainPassword     String?
  name              String
  role              Role       @default(AGENT)
  isActive          Boolean    @default(true)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  company               Company        @relation(fields: [companyId], references: [id])
  department            Department?  @relation(fields: [departmentId], references: [id])
  assignments           Assignment[]
  sentMessages          Message[]     @relation("SentMessages")
  auditLogs             AuditLog[]
  assignedConversations Conversation[] @relation("AssignedConversations")
  conversationNotes     ConversationNote[]
  passwordResetRequests PasswordResetRequest[]

  @@index([companyId, email])
  @@index([departmentId])
  @@map("users")
}

enum Role {
  ADMIN
  AGENT
}

model Conversation {
  id                     String             @id @default(uuid())
  companyId              String
  customerPhone          String
  customerName           String?
  status                 ConversationStatus @default(OPEN)
  departmentId           String?
  assignedUserId         String?
  flowState              FlowState          @default(GREETING)
  routedAt               DateTime?
  assignedAt             DateTime?
  timeoutAt              DateTime?
  greetingSentAt         DateTime?
  lastMessageAt          DateTime           @default(now())
  unreadCount            Int                @default(0)
  metadata               Json?
  lastDepartmentId       String?
  lastAttendantId        String?
  lastAttendedAt         DateTime?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt

  company      Company      @relation(fields: [companyId], references: [id])
  department   Department?  @relation(fields: [departmentId], references: [id])
  assignedUser User?        @relation("AssignedConversations", fields: [assignedUserId], references: [id])
  messages     Message[]
  assignments  Assignment[]
  notes        ConversationNote[]

  @@unique([companyId, customerPhone])
  @@index([companyId, status, lastMessageAt])
  @@index([departmentId])
  @@index([assignedUserId])
  @@map("conversations")
}

enum FlowState {
  GREETING
  DEPARTMENT_SELECTED
  ASSIGNED
  AWAITING_ROUTING_CONFIRMATION
  TIMEOUT_REDIRECT
  RESOLVED
}

enum ConversationStatus {
  OPEN
  ASSIGNED
  RESOLVED
  ARCHIVED
}

model Assignment {
  id             String       @id @default(uuid())
  conversationId String
  userId         String
  assignedAt     DateTime     @default(now())
  unassignedAt   DateTime?

  conversation Conversation @relation(fields: [conversationId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@index([conversationId, userId])
  @@map("assignments")
}

model Message {
  id                String        @id @default(uuid())
  companyId         String
  conversationId    String
  whatsappMessageId String?       @unique
  direction         Direction
  type              MessageType   @default(TEXT)
  content           String        @db.Text
  mediaUrl          String?
  status            MessageStatus @default(PENDING)
  isBot             Boolean       @default(false)
  sentById          String?
  sentAt            DateTime      @default(now())
  deliveredAt       DateTime?
  readAt            DateTime?
  metadata          Json?

  company      Company      @relation(fields: [companyId], references: [id])
  conversation Conversation @relation(fields: [conversationId], references: [id])
  sentBy       User?        @relation("SentMessages", fields: [sentById], references: [id])

  @@index([conversationId, sentAt])
  @@index([companyId, sentAt])
  @@map("messages")
}

enum Direction {
  INBOUND
  OUTBOUND
}

enum MessageType {
  TEXT
  IMAGE
  DOCUMENT
  AUDIO
  VIDEO
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

model QuickReply {
  id        String   @id @default(uuid())
  companyId String
  title     String
  content   String   @db.Text
  shortcut  String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id])

  @@index([companyId])
  @@map("quick_replies")
}

model ConversationNote {
  id             String       @id @default(uuid())
  conversationId String
  companyId      String
  authorId       String
  content        String       @db.Text
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  conversation   Conversation @relation(fields: [conversationId], references: [id])
  company        Company      @relation(fields: [companyId], references: [id])
  author         User         @relation(fields: [authorId], references: [id])

  @@index([conversationId])
  @@map("conversation_notes")
}

model AuditLog {
  id        String   @id @default(uuid())
  companyId String
  userId    String?
  action    String
  entity    String
  entityId  String?
  metadata  Json?
  timestamp DateTime @default(now())
  ipAddress String?

  company Company @relation(fields: [companyId], references: [id])
  user    User?   @relation(fields: [userId], references: [id])

  @@index([companyId, timestamp])
  @@index([userId, timestamp])
  @@map("audit_logs")
}

model PasswordResetRequest {
  id        String   @id @default(uuid())
  companyId String
  userId    String
  reason    String   @db.Text
  status    ResetStatus @default(PENDING)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id])
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId, status])
  @@index([userId])
  @@map("password_reset_requests")
}

enum ResetStatus {
  PENDING
  RESOLVED
}
